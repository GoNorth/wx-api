# 表单场景字段说明

## 概述

为 `biz_image_template` 和 `biz_image_product` 表添加表单场景相关字段，用于记录动态表单的选择和数据。

## 字段说明

### biz_image_template 表

#### form_scenario_id
- **类型**：`varchar(128)`
- **说明**：表单场景ID，关联 `biz_form_scenario` 表
- **用途**：记录模板选择了哪个场景控件form
- **索引**：已添加索引 `idx_form_scenario_id`
- **外键**：可选，可关联到 `biz_form_scenario.scenario_id`

**使用场景**：
- 在创建或编辑模板时，用户可以选择一个表单场景
- 该场景决定了模板使用哪些动态表单组件

### biz_image_product 表

#### form_scenario_id
- **类型**：`varchar(128)`
- **说明**：表单场景ID，关联 `biz_form_scenario` 表
- **用途**：记录产品图片选择了哪个场景控件form
- **索引**：已添加索引 `idx_form_scenario_id`
- **外键**：可选，可关联到 `biz_form_scenario.scenario_id`

**使用场景**：
- 在创建或编辑产品图片时，用户可以选择一个表单场景
- 该场景决定了产品图片使用哪些动态表单组件

#### form_scenario_json
- **类型**：`text`
- **说明**：表单场景JSON，保存控件列表的具体值
- **格式**：JSON格式存储
- **用途**：保存用户在动态表单中填写的所有字段值

**JSON格式示例**：
```json
{
  "dish_name": "宫保鸡丁",
  "dish_desc": "经典川菜，麻辣鲜香",
  "dish_category": "炒菜",
  "price": 38.00,
  "price_display": "有价格",
  "marketing_tags": ["新春特惠", "限时优惠"],
  "is_hot": true,
  "product_image": "https://example.com/images/product.jpg",
  "activity_details": "<p>活动详情内容</p>"
}
```

**字段映射规则**：
- JSON的key对应组件的 `componentCode`
- JSON的value对应用户在表单中填写的值
- 不同类型的组件值格式：
  - INPUT/TEXTAREA：字符串
  - NUMBER：数字
  - SELECT/RADIO：字符串（选项的value）
  - CHECKBOX：数组（选项的value数组）
  - SWITCH：布尔值
  - DATE/DATETIME：字符串（日期格式）
  - UPLOAD：字符串（文件URL）或数组（多个文件URL）
  - RICH_TEXT：字符串（HTML格式）

## 数据流程

### 1. 模板创建/编辑流程

1. 用户选择表单场景
   ```
   GET /manage/bizFormScenario/options
   ```
   返回场景下拉选项

2. 用户选择场景后，获取组件列表
   ```
   GET /manage/bizFormScenario/components/{scenarioId}
   ```
   返回该场景下的所有组件配置

3. 前端根据组件列表动态渲染表单

4. 用户填写表单并提交
   ```
   POST /manage/bizImageTemplate/save
   {
     "templateId": "...",
     "formScenarioId": "scenario_001",
     ...
   }
   ```

### 2. 产品图片创建/编辑流程

1. 用户选择表单场景（同模板流程）

2. 用户填写动态表单

3. 用户提交表单
   ```
   POST /manage/bizImageProduct/save
   {
     "productId": "...",
     "templateId": "...",
     "formScenarioId": "scenario_001",
     "formScenarioJson": "{\"dish_name\":\"宫保鸡丁\",\"price\":38.00,...}",
     ...
   }
   ```

4. 后端保存 `form_scenario_id` 和 `form_scenario_json`

### 3. 数据查询和展示

1. 查询产品图片时，可以：
   - 根据 `form_scenario_id` 获取场景信息
   - 解析 `form_scenario_json` 获取表单数据
   - 根据场景ID获取组件配置，用于展示表单

2. 前端展示时：
   ```javascript
   // 1. 获取场景信息
   GET /manage/bizFormScenario/info/{formScenarioId}
   
   // 2. 获取组件配置
   GET /manage/bizFormScenario/components/{formScenarioId}
   
   // 3. 解析 formScenarioJson
   const formData = JSON.parse(product.formScenarioJson);
   
   // 4. 根据组件配置和表单数据渲染表单
   ```

## 注意事项

1. **数据一致性**：
   - `form_scenario_id` 必须存在于 `biz_form_scenario` 表中
   - `form_scenario_json` 的字段必须与场景的组件配置匹配

2. **数据验证**：
   - 保存前应验证 `form_scenario_json` 的格式
   - 验证必填字段是否已填写
   - 验证字段值是否符合组件配置的规则（如maxLength、min、max等）

3. **数据迁移**：
   - 现有数据中，`form_scenario_id` 和 `form_scenario_json` 为 NULL
   - 需要逐步为现有数据补充表单场景信息

4. **外键约束**：
   - SQL脚本中提供了外键约束的注释代码
   - 如果需要强制关联，可以取消注释启用外键约束
   - 外键设置为 `ON DELETE SET NULL`，删除场景时不会删除关联数据

5. **JSON字段大小**：
   - `form_scenario_json` 使用 `text` 类型，可以存储较大的JSON数据
   - 如果单个表单数据非常大，可以考虑使用 `LONGTEXT` 类型

## 示例数据

### biz_image_template 示例
```sql
UPDATE `biz_image_template` 
SET `form_scenario_id` = 'scenario_001' 
WHERE `template_id` = 'tpl_001_20240115103000';
```

### biz_image_product 示例
```sql
INSERT INTO `biz_image_product` (
  `product_id`,
  `template_id`,
  `form_scenario_id`,
  `form_scenario_json`,
  ...
) VALUES (
  'prod_001',
  'tpl_001_20240115103000',
  'scenario_001',
  '{"dish_name":"宫保鸡丁","dish_desc":"经典川菜","dish_category":"炒菜","price":38.00,"price_display":"有价格","marketing_tags":["新春特惠"],"is_hot":true}',
  ...
);
```

